QUY TẮC VÀ CÔNG THỨC TÍNH LƯƠNG HƯU BHXH
============================================================

Tài liệu này mô tả chi tiết các quy tắc nghiệp vụ được sử dụng trong công cụ tính lương hưu. Tất cá các điều chỉnh đều được ghi vào đây để theo dõi.

1. NGUYÊN TẮC CHUNG
--------------------
- Công cụ tính toán dựa trên dữ liệu người dùng cung cấp (ngày sinh, giới tính, quá trình đóng) và các bảng tra cứu tham số (lương cơ sở, tỷ lệ trượt giá, v.v.).
- Toàn bộ logic tính toán được thực hiện ở phía máy chủ (Google Apps Script).
- Kết quả của mỗi lần tính toán được ghi lại vào một sheet có tên là `Log_huu` để đối soát.

2. CÁC ĐỊNH NGHĨA VÀ THAM SỐ
----------------------------
- **BHXH (Bắt buộc & Tự nguyện):** Cả hai loại hình đều được nhập chung, với loại đóng theo "Mức lương" đại diện cho cả BHXH tự nguyện và BHXH bắt buộc khu vực ngoài nhà nước, và "Hệ số" cho khu vực nhà nước.
- **Giai đoạn thai sản:** Được tính như một giai đoạn đóng BHXH, với mức đóng được kế thừa từ giai đoạn đóng BHXH bắt buộc liền trước đó.
- **Lương cơ sở:** Mức lương do nhà nước quy định, thay đổi theo từng thời kỳ. Được tra cứu từ sheet `luongcoso`.
- **Tỷ lệ trượt giá (Chỉ số giá tiêu dùng):** Dùng để điều chỉnh tiền lương đã đóng BHXH về giá trị hiện tại. Được tra cứu từ sheet `tyletruotgia`.

3. QUY TRÌNH TÍNH TOÁN
----------------------

### Bước 1: Xử lý dữ liệu đầu vào
- Chuyển đổi tất cả các giai đoạn đóng BHXH do người dùng nhập thành một danh sách các tháng đóng riêng lẻ, có đầy đủ thông tin (loại hình, mức đóng, v.v.).
- Nếu thời điểm bắt đầu tham gia BHXH từ ngày 01/01/2016 thì xử lý các giai đoạn đóng theo **hệ số** từ ngày 01/01/2016 trở đi: Các giai đoạn này được chuyển đổi thành giai đoạn đóng theo **mức lương**, với công thức:
  `Mức lương tháng = Tổng hệ số tháng * Mức lương cơ sở tại tháng đó`
- Tính toán tiền lương đã điều chỉnh cho từng tháng:
  `Lương điều chỉnh tháng = Mức lương đóng BHXH tháng * Tỷ lệ trượt giá của năm đó`

### Bước 2: Tính toán các chỉ số chính

1.  **Tính Mức bình quân tiền lương (MBQTL) toàn quá trình:**
    - MBQTL là bình quân gia quyền của tất cả các tháng đã đóng BHXH.
    - `MBQTL = (Tổng tiền lương đóng BHXH của tất cả các tháng) / (Tổng số tháng đã đóng)`
    - Cách tính "Tổng tiền lương đóng BHXH của tất cả các tháng":
        - **Đối với các tháng đóng theo mức lương:** Lấy tổng của `Lương điều chỉnh tháng` (đã tính ở Bước 1).
        - **Đối với các tháng đóng theo hệ số:**
          - Xác định số năm cuối cần lấy để tính bình quân (tra cứu sheet `sonambq` dựa vào năm bắt đầu tham gia).
          - Lấy `N` tháng đóng theo hệ số gần nhất (`N = số năm * 12`).
          - `M` là số tháng thực tế để tính bình quân = min(N, tổng số tháng đóng theo hệ số).
          - `Bình quân lương hệ số = (Tổng hệ số của M tháng / M) * Lương cơ sở tại thời điểm tính`.
          - `Tổng tiền lương cho giai đoạn hệ số = Bình quân lương hệ số * Tổng số tháng đóng theo hệ số`.

2.  **Tính Tỷ lệ hưởng lương hưu:**
    - Tính tổng số năm đóng BHXH (số tháng lẻ từ 7-11 tháng được làm tròn thành 1 năm).
    - **Đối với Nam:**
        - 15 năm đầu đóng được 40%.
        - Từ năm thứ 16 đến năm thứ 20, mỗi năm cộng thêm 1% (đạt 45% tại năm thứ 20).
        - Từ năm thứ 21 trở đi, mỗi năm cộng thêm 2%.
    - **Đối với Nữ:**
        - 15 năm đầu đóng được 45%.
        - Từ năm thứ 16 trở đi, mỗi năm cộng thêm 2%.
    - Tỷ lệ hưởng tối đa là 75%.

3.  **Tính Tiền lương hưu hàng tháng:**
    `Lương hưu tháng = MBQTL * Tỷ lệ hưởng lương hưu`

4.  **Tính Trợ cấp một lần (nếu có):**
    - Áp dụng khi số năm đóng vượt mức tối đa để hưởng 75% (35 năm đối với Nam, 30 năm đối với Nữ).
    - `Trợ cấp = (Số năm đóng vượt) * 0.5 * Lương hưu tháng`

### Bước 3: Tổng hợp kết quả và ghi log
- Tổng hợp các kết quả tính được: Lương hưu hàng tháng, Trợ cấp một lần.
- Tạo một chuỗi diễn giải chi tiết về cách tính (tổng thời gian đóng, tỷ lệ hưởng, MBQTL).
- Ghi lại các thông số đầu vào và kết quả vào sheet `Log_huu`.
